<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.1"><meta name="generator" content="Jekyll v4.1.1" /><meta property="og:title" content="Trying out different interpreter implementations" /><meta name="author" content="Félix-Antoine Ouellet" /><meta property="og:locale" content="en_US" /><meta name="description" content="Exercise in optimisations (and madness)" /><meta property="og:description" content="Exercise in optimisations (and madness)" /><link rel="canonical" href="https://faouellet.github.io//interpreter/" /><meta property="og:url" content="https://faouellet.github.io//interpreter/" /><meta property="og:site_name" content="/* Insert Code Here */" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-07-14T00:00:00-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Trying out different interpreter implementations" /> <script type="application/ld+json"> {"description":"Exercise in optimisations (and madness)","url":"https://faouellet.github.io//interpreter/","headline":"Trying out different interpreter implementations","dateModified":"2020-07-14T00:00:00-04:00","@type":"BlogPosting","datePublished":"2020-07-14T00:00:00-04:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://faouellet.github.io//interpreter/"},"author":{"@type":"Person","name":"Félix-Antoine Ouellet"},"@context":"https://schema.org"}</script><title>Trying out different interpreter implementations | /* Insert Code Here */</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-71911238-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-71911238-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">/* Insert Code Here */</a></div><div class="site-subtitle font-italic"></div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/faouellet" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://www.linkedin.com/in/felixantoineouellet/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['faouellet','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Trying out different interpreter implementations</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Trying out different interpreter implementations</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Jul 14, 2020, 12:00 AM -0400" > Jul 14, 2020 <i class="unloaded">2020-07-14T00:00:00-04:00</i> </span> by <span class="author"> Félix-Antoine Ouellet </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2602 words">14 min</span></div></div><div class="post-content"><hr /><p>All the code for this article can be found <a href="https://github.com/faouellet/Interpreters">here</a>.</p><hr /><p>I’ve always been fascinated by video game console emulators. How could they even make a random computer act like something it’s not as if it was a teenager trying to fit in with the “cool” crowd. Working on my first emulator back when I was an undergraduate student, I answered some of my interrogations on the subject. Lo and behold, an emulator (for simple systems), at its most basic, is nothing more than an interpreter working on a particular machine code. That is to say, creating an emulator (again, for simple systems) comes down to implementing a dumb fetch-decode-execute cycle for a particular instruction set.</p><figure><p style="text-align:center;"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/FDE.png" alt="Image: Dumb but effective" /></p><figcaption><span><center><i>Dumb but effective</i></center></span></figcaption></figure><p>Being a performance junkie, I then began to muse about how this simple cycle could be implemented in the most optimal way. What follows is the tale of what can be engineered when you decide to sacrifice sanity at the altar of speed.</p><h2 id="benchmarking">Benchmarking</h2><p>In the cold hard world of computer science, you can’t prove the benefits of some data structure or algorithm unless you show some benchmarks. Otherwise, our work would be based on faith and hype and, most likely, false advertising. This is how sales people work, not us computer scientists. Consequently, we need an experimental setup i.e. a machine to emulate.</p><h3 id="the-machine">The machine</h3><p>For the sake of simplicity, I propose a simple calculator machine. It’ll have an internal accumulator that’ll evidently be initialized to 0 and will change according to the instructions that it’ll execute. Each of these instructions will be two bytes long. The first byte will be the opcode i.e. the operation to perform. These operations will either be a binary arithmetic operation or a special operation signifying that the computation has come to an end. The second byte will be the operand i.e. the second term to use in a binary operation (the first term being obviously the accumulator). In addition, the machine will also possess a program counter (PC) to indicate which instruction it should be executing. Putting all of these requirements into code produce something like this:</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Calculator</span>
<span class="p">{</span>
<span class="nl">public:</span>
  <span class="k">enum</span> <span class="n">Opcode</span> <span class="p">{</span> <span class="n">ADD</span><span class="p">,</span> <span class="n">DIV</span><span class="p">,</span> <span class="cm">/* ... */</span><span class="p">,</span> <span class="n">END</span> <span class="p">};</span>

<span class="nl">public:</span>
  <span class="kt">long</span> <span class="n">Execute</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">&gt;&amp;</span> <span class="n">program</span><span class="p">);</span>

<span class="nl">private:</span>
  <span class="kt">long</span> <span class="n">m_accumulator</span><span class="p">{};</span>
  <span class="kt">int</span>  <span class="n">m_pc</span><span class="p">{};</span>
<span class="p">};</span>
</pre></table></code></div></div><p>However, while fine and dandy, I won’t use this representation in what follows. Instead, the machine will be encoded implicitly in the functions that’ll serve as interpreters.</p><h3 id="the-program">The program</h3><p>Verily, I have but two requirements for a test program.</p><ol><li>Respect the instruction two bytes format outlined above.<li>Contain a <del><strong>deleted expletive</strong></del> load of instructions so we can have meaningful benchmarks.</ol><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">&gt;</span> <span class="n">GenerateProgram</span><span class="p">(</span><span class="kt">int</span> <span class="n">nbInst</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">&gt;</span> <span class="n">program</span><span class="p">;</span>

  <span class="n">std</span><span class="o">::</span><span class="n">random_device</span> <span class="n">device</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">mt19937</span> <span class="n">engine</span><span class="p">(</span><span class="n">device</span><span class="p">());</span>
  <span class="n">std</span><span class="o">::</span><span class="n">uniform_int_distribution</span><span class="o">&lt;&gt;</span> <span class="n">opcodeDistribution</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">uniform_int_distribution</span><span class="o">&lt;&gt;</span> <span class="n">operandDistribution</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span>

  <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iOp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">iOp</span> <span class="o">&lt;</span> <span class="n">nbInst</span><span class="p">;</span> <span class="o">++</span><span class="n">iOp</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">program</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">opcodeDistribution</span><span class="p">(</span><span class="n">engine</span><span class="p">));</span>
    <span class="n">program</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">operandDistribution</span><span class="p">(</span><span class="n">engine</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="n">program</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>   <span class="c1">// END</span>

  <span class="k">return</span> <span class="n">program</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>For all results shown below, <strong><code class="language-plaintext highlighter-rouge">nbInst</code></strong> was 10,000,000.</p><h3 id="the-testing-method">The testing method</h3><p>One or two measurement does not a serious benchmark make. To get serious, you need to have tools that’ll allow you to take as many sample as you want. I offer the below lambda as such a tool.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="k">auto</span> <span class="n">TimedExec</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">program</span><span class="p">](</span><span class="k">auto</span><span class="o">&amp;&amp;</span> <span class="n">callable</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbRepetition</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="p">;</span>

  <span class="n">nanoseconds</span> <span class="n">total</span><span class="p">{};</span>

  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">iRep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">iRep</span> <span class="o">&lt;</span> <span class="n">nbRepetition</span><span class="p">;</span> <span class="o">++</span><span class="n">iRep</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">const</span> <span class="k">auto</span> <span class="n">start</span> <span class="o">=</span> <span class="n">system_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
    <span class="n">callable</span><span class="p">(</span><span class="n">program</span><span class="p">);</span>
    <span class="k">const</span> <span class="k">auto</span> <span class="n">elapsed</span> <span class="o">=</span> <span class="n">system_clock</span><span class="o">::</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
    <span class="n">total</span> <span class="o">+=</span> <span class="n">elapsed</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">const</span> <span class="k">auto</span> <span class="n">meanTime</span> <span class="o">=</span> <span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">milliseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">total</span> <span class="o">/</span> <span class="n">nbRepetition</span><span class="p">).</span><span class="n">count</span><span class="p">();</span>

  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Mean elapsed time: "</span> <span class="o">&lt;&lt;</span> <span class="n">meanTime</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">};</span>
</pre></table></code></div></div><p>For all results shown below, <strong><code class="language-plaintext highlighter-rouge">nbRepetition</code></strong> was 100.</p><h3 id="perf">perf</h3><p>At this point, we have the test data and the testing method but no means to interpret (pun intended) the results. You could (and should) accept all my explanations like a wave of knowledge washing over you but I doubt that’ll satisfy everyone. Therefore, for the incredulous Thomases, I’ll use the Linux program <a href="https://perf.wiki.kernel.org/index.php/Main_Page">perf</a> to offer a glimpse into what’s happening with the CPU as the interpreter execute a program.</p><h2 id="interpreters">Interpreters</h2><h3 id="indirect-switch-interpreter">Indirect Switch Interpreter</h3><blockquote><p>A program of a thousand instructions begins with a single opcode</p><p>– <em>Laozi (ish)</em></p></blockquote><p>The first naive approach that I’ve explored was the indirect switch interpreter. In this algorithm, the logic of the emulated opcodes is encapsulated into an hash map of functions. A switch statement then drives the execution of the interpreter by calling the right function based on the opcode pointed by the PC.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre><td class="rouge-code"><pre><span class="k">using</span> <span class="n">Program</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">using</span> <span class="n">OpcodeFtor</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="k">const</span> <span class="n">Program</span><span class="o">&amp;</span><span class="p">,</span> <span class="kt">int</span><span class="o">&amp;</span><span class="p">,</span> <span class="kt">long</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">using</span> <span class="n">OpcodeTable</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">Opcode</span><span class="p">,</span> <span class="n">OpcodeFtor</span><span class="o">&gt;</span><span class="p">;</span>

<span class="kt">long</span> <span class="nf">IndirectSwitchInterpret</span><span class="p">(</span><span class="k">const</span> <span class="n">Program</span><span class="o">&amp;</span> <span class="n">program</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">static</span> <span class="n">OpcodeTable</span> <span class="n">table</span> <span class="o">=</span> <span class="p">{</span>
      <span class="p">{</span> <span class="n">ADD</span><span class="p">,</span> <span class="p">[](</span><span class="k">const</span> <span class="n">Program</span><span class="o">&amp;</span> <span class="n">program</span><span class="p">,</span> <span class="kt">int</span><span class="o">&amp;</span> <span class="n">pc</span><span class="p">,</span> <span class="kt">long</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span>
             <span class="p">{</span> <span class="n">value</span> <span class="o">+=</span> <span class="n">program</span><span class="p">[</span><span class="o">++</span><span class="n">pc</span><span class="p">];</span> <span class="o">++</span><span class="n">pc</span><span class="p">;</span> <span class="p">}</span> <span class="p">},</span>
      <span class="p">{</span> <span class="n">DIV</span><span class="p">,</span> <span class="p">[](</span><span class="k">const</span> <span class="n">Program</span><span class="o">&amp;</span> <span class="n">program</span><span class="p">,</span> <span class="kt">int</span><span class="o">&amp;</span> <span class="n">pc</span><span class="p">,</span> <span class="kt">long</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span>
             <span class="p">{</span> <span class="n">value</span> <span class="o">/=</span> <span class="n">program</span><span class="p">[</span><span class="o">++</span><span class="n">pc</span><span class="p">];</span> <span class="o">++</span><span class="n">pc</span><span class="p">;</span> <span class="p">}</span> <span class="p">},</span>
      <span class="c1">// Add any other you'd like here</span>
    <span class="p">};</span>

  <span class="kt">long</span> <span class="n">value</span><span class="p">{};</span>
  <span class="kt">int</span> <span class="n">pc</span><span class="p">{};</span>
  <span class="k">const</span> <span class="kt">size_t</span> <span class="n">programSize</span> <span class="o">=</span> <span class="n">program</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>

  <span class="k">while</span><span class="p">(</span><span class="n">pc</span> <span class="o">&lt;</span> <span class="n">programSize</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">program</span><span class="p">[</span><span class="n">pc</span><span class="p">])</span>
    <span class="p">{</span>
      <span class="k">case</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">table</span><span class="p">[</span><span class="n">program</span><span class="p">[</span><span class="n">pc</span><span class="p">]](</span><span class="n">program</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">table</span><span class="p">[</span><span class="n">program</span><span class="p">[</span><span class="n">pc</span><span class="p">]](</span><span class="n">program</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="c1">/////////////////////////////////</span>
      <span class="cm">/* Add some more to your taste */</span>
      <span class="c1">/////////////////////////////////</span>
      <span class="k">case</span> <span class="mi">8</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
      <span class="nl">default:</span>
        <span class="n">assert</span><span class="p">(</span><span class="nb">false</span> <span class="o">&amp;&amp;</span> <span class="s">"Unknown opcode"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>  

  <span class="n">assert</span><span class="p">(</span><span class="nb">false</span> <span class="o">&amp;&amp;</span> <span class="s">"Program has no END"</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Running this interpreter, we find out that it takes on average 135 ms to execute a program. In other words, as an English-Canadian friend of mine would say, it’s as slow as molasses going uphill on a cold January morning.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>Average program execution <span class="nb">time</span>:
indirectswitch: 135 ms
</pre></table></code></div></div><p>Just to get a clearer picture of our starting point, here’s an excerpt of the output of <em>perf stat</em> for this interpreter in table form:</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left"> <th style="text-align: left">cycles<th style="text-align: left">instructions<th style="text-align: left">branches<th style="text-align: left">branch misses<tbody><tr><td style="text-align: left"><em><strong>Indirect Switch</strong></em><td style="text-align: left"><em><strong>49,411,804,258</strong></em><td style="text-align: left"><em><strong>31,449,115,840</strong></em><td style="text-align: left"><em><strong>8,173,865,583</strong></em><td style="text-align: left"><em><strong>894,486,176</strong></em></table></div><h3 id="loop-interpreter">Loop Interpreter</h3><blockquote><p>Every subroutine should be made as simple as possible, but not simpler.</p><p>– <em>Albert Einstein (ish)</em></p></blockquote><p>It’s plain to see that the previous code snippet exhibit a criminal disregard of the DRY (Don’t Repeat Yourself) principle. The most obvious way to improve it (at least in terms of readability) was to substitute the switch for a direct call to the function implemeting the current opcode.</p><p><strong>Do note though that this approach only works because of the way I’ve designed the calculator machine. Real machine instruction opcodes are rarely this linear and makes the previous interpreter a better first approach</strong>.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="kt">long</span> <span class="nf">LoopInterpret</span><span class="p">(</span><span class="k">const</span> <span class="n">Program</span><span class="o">&amp;</span> <span class="n">program</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">static</span> <span class="n">OpcodeTable</span> <span class="n">table</span> <span class="o">=</span> <span class="p">{</span>
      <span class="p">[](</span><span class="k">const</span> <span class="n">Program</span><span class="o">&amp;</span> <span class="n">program</span><span class="p">,</span> <span class="kt">int</span><span class="o">&amp;</span> <span class="n">pc</span><span class="p">,</span> <span class="kt">long</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span>
      <span class="p">{</span> <span class="n">value</span> <span class="o">+=</span> <span class="n">program</span><span class="p">[</span><span class="o">++</span><span class="n">pc</span><span class="p">];</span> <span class="o">++</span><span class="n">pc</span><span class="p">;</span> <span class="p">},</span>
      <span class="p">[](</span><span class="k">const</span> <span class="n">Program</span><span class="o">&amp;</span> <span class="n">program</span><span class="p">,</span> <span class="kt">int</span><span class="o">&amp;</span> <span class="n">pc</span><span class="p">,</span> <span class="kt">long</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span>
      <span class="p">{</span> <span class="n">value</span> <span class="o">/=</span> <span class="n">program</span><span class="p">[</span><span class="o">++</span><span class="n">pc</span><span class="p">];</span> <span class="o">++</span><span class="n">pc</span><span class="p">;</span> <span class="p">}</span>
      <span class="c1">// Extend it as you wish</span>
  <span class="p">};</span>

  <span class="kt">long</span> <span class="n">value</span><span class="p">{};</span>
  <span class="kt">int</span> <span class="n">pc</span><span class="p">{};</span>
  <span class="k">const</span> <span class="kt">size_t</span> <span class="n">programSize</span> <span class="o">=</span> <span class="n">program</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>

  <span class="k">while</span><span class="p">(</span><span class="n">pc</span> <span class="o">&lt;</span> <span class="n">programSize</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">program</span><span class="p">[</span><span class="n">pc</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">assert</span><span class="p">(</span><span class="nb">false</span> <span class="o">&amp;&amp;</span> <span class="s">"Unknown opcode"</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">program</span><span class="p">[</span><span class="n">pc</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">table</span><span class="p">[</span><span class="n">program</span><span class="p">[</span><span class="n">pc</span><span class="p">]](</span><span class="n">program</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">assert</span><span class="p">(</span><span class="nb">false</span> <span class="o">&amp;&amp;</span> <span class="s">"Program has no END"</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>If we go to the judges’ scorecards, we see that it now takes on average 125 ms ot execute a program. The gains are there but they aren’t that spectacular (yet).</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>Average program execution <span class="nb">time</span>:
indirectswitch: 135 ms
loop: 125 ms
</pre></table></code></div></div><p>What does <em>perf</em> says?</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left"> <th style="text-align: left">cycles<th style="text-align: left">instructions<th style="text-align: left">branches<th style="text-align: left">branch misses<tbody><tr><td style="text-align: left">Indirect Switch<td style="text-align: left">49,411,804,258<td style="text-align: left">31,449,115,840<td style="text-align: left">8,173,865,583<td style="text-align: left">894,486,176<tr><td style="text-align: left"><em><strong>Loop</strong></em><td style="text-align: left"><em><strong>47,714,383,334</strong></em><td style="text-align: left"><em><strong>33,451,525,769</strong></em><td style="text-align: left"><em><strong>6,299,707,023</strong></em><td style="text-align: left"><em><strong>885,182,452</strong></em></table></div><p>Interesting. This interpreter executes more instructions than the Indirect Switch Interpreter yet it runs faster. How come? Wouldn’t more instructions put more pressure on the instructions cache (icache) and therefore results in slower code?</p><p>The answer is: it depends. If we execute the same instructions over and over again, the icache will contribute to glorious results. If not, it will thrashed as often a freshman during initiation week.</p><p>Furthermore, in this situation, you have to consider that this interpreter went through far fewer branches than the previous interpreter. While it’s true that modern CPU have powerful branch predictors to keep the instructions flowing in the pipeline as much as possible, the sad truth is that they’re not omniscient. They can mispredict and when they do, a pipeline flush is necessary. Evidently, this flushes both instructions and performance down the drain.</p><h3 id="direct-switch-interpreter">Direct Switch Interpreter</h3><blockquote><p>We can solve any problem by introducing an extra level of indirection, except for the problem of too many levels of indirection.</p><p>– <em>Andrew Koening (ish)</em></p></blockquote><p>By this point, I began to see the cracks in the teaching of my forebears. Adding a layer of indirection might not be such a good advice in all cases. In fact, I began to question if our love for indirection might not be the result of Orwellian conditioning passed down from previous generations of programmers.</p><p>Defying my predecessors, I went for it; I put the opcode handling logic directly inside the <strong><code class="language-plaintext highlighter-rouge">case</code></strong> where it belonged. For a machine so small, it could be done so easily after all.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="kt">long</span> <span class="nf">DirectSwitchInterpret</span><span class="p">(</span><span class="k">const</span> <span class="n">Program</span><span class="o">&amp;</span> <span class="n">program</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">long</span> <span class="n">value</span><span class="p">{};</span>
  <span class="kt">int</span> <span class="n">pc</span><span class="p">{};</span>
  <span class="k">const</span> <span class="kt">size_t</span> <span class="n">programSize</span> <span class="o">=</span> <span class="n">program</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>

  <span class="k">while</span><span class="p">(</span><span class="n">pc</span> <span class="o">&lt;</span> <span class="n">programSize</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">program</span><span class="p">[</span><span class="n">pc</span><span class="p">])</span>
    <span class="p">{</span>
      <span class="k">case</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">+=</span> <span class="n">program</span><span class="p">[</span><span class="o">++</span><span class="n">pc</span><span class="p">];</span>
        <span class="o">++</span><span class="n">pc</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">/=</span> <span class="n">program</span><span class="p">[</span><span class="o">++</span><span class="n">pc</span><span class="p">];</span>
        <span class="o">++</span><span class="n">pc</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">*=</span> <span class="n">program</span><span class="p">[</span><span class="o">++</span><span class="n">pc</span><span class="p">];</span>
        <span class="o">++</span><span class="n">pc</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="c1">//////////////////////////</span>
      <span class="cm">/* Use your imagination */</span>
      <span class="c1">//////////////////////////</span>
      <span class="k">case</span> <span class="mi">8</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
      <span class="nl">default:</span>
        <span class="n">assert</span><span class="p">(</span><span class="nb">false</span> <span class="o">&amp;&amp;</span> <span class="s">"Unknown opcode"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">assert</span><span class="p">(</span><span class="nb">false</span> <span class="o">&amp;&amp;</span> <span class="s">"Program has no END"</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>From an 124 ms mean program execution time, we’re now down to an 94 ms. The numbers did not lie, I was on the track to success.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>Average program execution <span class="nb">time</span>:
indirectswitch: 135 ms
loop: 125 ms
directswitch: 94 ms
</pre></table></code></div></div><p>In fact, <em>perf</em> was painting quite a clear picture now:</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left"> <th style="text-align: left">cycles<th style="text-align: left">instructions<th style="text-align: left">branches<th style="text-align: left">branch misses<tbody><tr><td style="text-align: left">Indirect Switch<td style="text-align: left">49,411,804,258<td style="text-align: left">31,449,115,840<td style="text-align: left">8,173,865,583<td style="text-align: left">894,486,176<tr><td style="text-align: left">Loop<td style="text-align: left">47,714,383,334<td style="text-align: left">33,451,525,769<td style="text-align: left">6,299,707,023<td style="text-align: left">885,182,452<tr><td style="text-align: left"><em><strong>Direct Switch</strong></em><td style="text-align: left"><em><strong>35,298,486,061</strong></em><td style="text-align: left"><em><strong>13,072,102,988</strong></em><td style="text-align: left"><em><strong>4,173,586,593</strong></em><td style="text-align: left"><em><strong>885,258,057</strong></em></table></div><p>Simpler programs produce more optimized binary code that need to execute less instructions to produce the same result. Case in point: the Direct Switch Interpreter executed instructions count is a little over a third of the Indirect Switch Interpreter.</p><p>For a second time I had whispers that branches had to go; we should get rid of them like Starks at the Red Wedding.</p><h3 id="indirect-threaded-interpreter">Indirect Threaded Interpreter</h3><blockquote><p>Behold I teach you the computed goto: it is that lightning, it is that madness!</p><p>– <em>Friedrich Nietzsche (ish)</em></p></blockquote><p>I knew what had to be done. I had to remove branches as if I was deforesting the Amazon rainforest. Since common wisdom could not help me anymore, I had to turn to the arcane.</p><p>In the land of C/C++ language extensions, there exist something called a computed goto. As far as I can tell, it spawned from the womb of <a href="https://gcc.gnu.org/onlinedocs/gcc/Labels-as-Values.html">GCC</a>. What it all boils down to two is an unholy union of two ghastly features. First, it allows for storing label addresses inside (<strong><code class="language-plaintext highlighter-rouge">void*</code></strong>) variables. Second, it grants the possibility of invoking a <strong><code class="language-plaintext highlighter-rouge">goto</code></strong> on a variable expression. What all of this enabled me to do was to create a new jump table which negated the need for a loop inside the interpreter.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="kt">long</span> <span class="nf">IndirectThreadedInterpret</span><span class="p">(</span><span class="k">const</span> <span class="n">Program</span><span class="o">&amp;</span> <span class="n">program</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">static</span> <span class="kt">void</span><span class="o">*</span> <span class="n">funcs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&amp;&amp;</span><span class="n">ADD</span><span class="p">,</span> <span class="o">&amp;&amp;</span><span class="n">DIV</span><span class="p">,</span> <span class="o">&amp;&amp;</span><span class="n">MUL</span><span class="p">,</span> <span class="o">&amp;&amp;</span><span class="n">SUB</span><span class="p">,</span>
                           <span class="o">&amp;&amp;</span><span class="n">MOD</span><span class="p">,</span> <span class="o">&amp;&amp;</span><span class="n">AND</span><span class="p">,</span> <span class="o">&amp;&amp;</span><span class="n">OR</span><span class="p">,</span> <span class="o">&amp;&amp;</span><span class="n">XOR</span><span class="p">,</span> <span class="o">&amp;&amp;</span><span class="n">END</span> <span class="p">};</span>
  <span class="kt">long</span> <span class="n">value</span><span class="p">{};</span>
  <span class="kt">int</span> <span class="n">pc</span><span class="p">{};</span>
  <span class="k">goto</span> <span class="o">*</span><span class="n">funcs</span><span class="p">[</span><span class="n">program</span><span class="p">[</span><span class="n">pc</span><span class="p">]];</span>

<span class="nl">ADD:</span>
   <span class="n">value</span> <span class="o">+=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">program</span><span class="p">[</span><span class="o">++</span><span class="n">pc</span><span class="p">]);</span>
   <span class="k">goto</span> <span class="o">*</span><span class="n">funcs</span><span class="p">[</span><span class="n">program</span><span class="p">[</span><span class="o">++</span><span class="n">pc</span><span class="p">]];</span>
<span class="nl">DIV:</span>
   <span class="n">value</span> <span class="o">/=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">program</span><span class="p">[</span><span class="o">++</span><span class="n">pc</span><span class="p">]);</span>
   <span class="k">goto</span> <span class="o">*</span><span class="n">funcs</span><span class="p">[</span><span class="n">program</span><span class="p">[</span><span class="o">++</span><span class="n">pc</span><span class="p">]];</span>
<span class="c1">///////////////////////////////////////</span>
<span class="cm">/* Use the power of your imagination */</span>
<span class="c1">///////////////////////////////////////</span>
<span class="nl">END:</span>
  <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Executing this new interpreter, we again were able to further gain some precious milliseconds in our benchmark.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>Average program execution <span class="nb">time</span>:
indirectswitch: 135 ms
loop: 125 ms
directswitch: 94 ms
indirectthreaded: 91 ms
</pre></table></code></div></div><p>Not great but not terrible either.</p><p>What happened? <em>perf</em>, tell me that I’m going in the right direction!</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left"> <th style="text-align: left">cycles<th style="text-align: left">instructions<th style="text-align: left">branches<th style="text-align: left">branch misses<tbody><tr><td style="text-align: left">Indirect Switch<td style="text-align: left">49,411,804,258<td style="text-align: left">31,449,115,840<td style="text-align: left">8,173,865,583<td style="text-align: left">894,486,176<tr><td style="text-align: left">Loop<td style="text-align: left">47,714,383,334<td style="text-align: left">33,451,525,769<td style="text-align: left">6,299,707,023<td style="text-align: left">885,182,452<tr><td style="text-align: left">Direct Switch<td style="text-align: left">35,298,486,061<td style="text-align: left">13,072,102,988<td style="text-align: left">4,173,586,593<td style="text-align: left">885,258,057<tr><td style="text-align: left"><em><strong>Indirect Threaded</strong></em><td style="text-align: left"><em><strong>36,260,932,871</strong></em><td style="text-align: left"><em><strong>13,072,319,964</strong></em><td style="text-align: left"><em><strong>1,298,940,541</strong></em><td style="text-align: left"><em><strong>885,142,693</strong></em></table></div><p>Damn it all! Despite getting rid of about three quarters of the remaining branches I had not made the progress I was hoping for.</p><h3 id="direct-threaded-interpreter">Direct Threaded Interpreter</h3><blockquote><p>The C++ language is indeed comic, but the joke is on programmers.</p><p>– <em>H.P. Lovecraft (ish)</em></p></blockquote><p>At this point, I realized that to quench my need for speed, executing the program as it was given to me was a fool’s errand. I still had one too many indirection: indexing into the <strong><code class="language-plaintext highlighter-rouge">funcs</code></strong> arrays. What I need to do was decipher the program into a form where all it had to do was perform an arithmetic operation and strictly follow a pointer to the next operation.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="kt">long</span> <span class="nf">DirectThreadedInterpret</span><span class="p">(</span><span class="k">const</span> <span class="n">Program</span><span class="o">&amp;</span> <span class="n">program</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">funcs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&amp;&amp;</span><span class="n">ADD</span><span class="p">,</span> <span class="o">&amp;&amp;</span><span class="n">DIV</span><span class="p">,</span> <span class="o">&amp;&amp;</span><span class="n">MUL</span><span class="p">,</span> <span class="o">&amp;&amp;</span><span class="n">SUB</span><span class="p">,</span>
                           <span class="o">&amp;&amp;</span><span class="n">MOD</span><span class="p">,</span> <span class="o">&amp;&amp;</span><span class="n">AND</span><span class="p">,</span> <span class="o">&amp;&amp;</span><span class="n">OR</span><span class="p">,</span> <span class="o">&amp;&amp;</span><span class="n">XOR</span><span class="p">,</span> <span class="o">&amp;&amp;</span><span class="n">END</span> <span class="p">};</span>

  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*&gt;</span> <span class="n">bytecode</span><span class="p">;</span>
  <span class="n">bytecode</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">program</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">program</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">bytecode</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">funcs</span><span class="p">[</span><span class="n">program</span><span class="p">[</span><span class="n">i</span><span class="p">]]));</span>
    <span class="n">bytecode</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">&amp;</span><span class="n">program</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="kt">long</span> <span class="n">value</span><span class="p">{};</span>
  <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">**</span> <span class="n">pc</span> <span class="o">=</span> <span class="n">bytecode</span><span class="p">.</span><span class="n">data</span><span class="p">();</span>
  <span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">nextFunc</span> <span class="o">=</span> <span class="o">*</span><span class="n">pc</span><span class="p">;</span>
  <span class="k">goto</span> <span class="o">*</span><span class="n">nextFunc</span><span class="p">;</span>

<span class="nl">ADD:</span>
  <span class="n">value</span> <span class="o">+=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="o">**++</span><span class="n">pc</span><span class="p">);</span>
  <span class="n">nextFunc</span> <span class="o">=</span> <span class="o">*++</span><span class="n">pc</span><span class="p">;</span>
  <span class="k">goto</span> <span class="o">*</span><span class="n">nextFunc</span><span class="p">;</span>
<span class="nl">DIV:</span>
  <span class="n">value</span> <span class="o">/=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="o">**++</span><span class="n">pc</span><span class="p">);</span>
  <span class="n">nextFunc</span> <span class="o">=</span> <span class="o">*++</span><span class="n">pc</span><span class="p">;</span>
  <span class="k">goto</span> <span class="o">*</span><span class="n">nextFunc</span><span class="p">;</span>
  <span class="c1">/////////////////////////////////////////////////////</span>
  <span class="cm">/* Add as many arithmetic operations as you'd like */</span>
  <span class="c1">/////////////////////////////////////////////////////</span>
<span class="nl">END:</span>
  <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Finally! The promised land! The promised speed! This interpreter flys on an average of 50 ms per program execution i.e. less than half of the original interpreter.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>Average program execution <span class="nb">time</span>:
indirectswitch: 135 ms
loop: 125 ms
directswitch: 94 ms
indirectthreaded: 91 ms
directthreaded: 50 ms
</pre></table></code></div></div><p>This is unsurprising when looking at the interpreter from <em>perf</em>’s perspective:</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left"> <th style="text-align: left">cycles<th style="text-align: left">instructions<th style="text-align: left">branches<th style="text-align: left">branch misses<tbody><tr><td style="text-align: left">Indirect Switch<td style="text-align: left">49,411,804,258<td style="text-align: left">31,449,115,840<td style="text-align: left">8,173,865,583<td style="text-align: left">894,486,176<tr><td style="text-align: left">Loop<td style="text-align: left">47,714,383,334<td style="text-align: left">33,451,525,769<td style="text-align: left">6,299,707,023<td style="text-align: left">885,182,452<tr><td style="text-align: left">Direct Switch<td style="text-align: left">35,298,486,061<td style="text-align: left">13,072,102,988<td style="text-align: left">4,173,586,593<td style="text-align: left">885,258,057<tr><td style="text-align: left">Indirect Threaded<td style="text-align: left">36,260,932,871<td style="text-align: left">13,072,319,964<td style="text-align: left">1,298,940,541<td style="text-align: left">885,142,693<tr><td style="text-align: left"><em><strong>Direct Threaded</strong></em><td style="text-align: left"><em><strong>20,817,034,936</strong></em><td style="text-align: left"><em><strong>5,797,820,373</strong></em><td style="text-align: left"><em><strong>1,405,419,279</strong></em><td style="text-align: left"><em><strong>883,918,185</strong></em></table></div><p>Yes, there are more branches in this program. However, I suspect that most of these “branches” might only be direct jumps. What’s more, the number of executed instructions has fallen off a cliff. This is most likely due to the eradication of indirect accesses in this interpreter. With that there are way less address computations and we now go to (pun intended) the next instruction quicker.</p><h2 id="the-end">The End</h2><p>There is still much to discuss concerning the inner workings of interpreters (or emulators for that matter). Truth be told, to create an emulator of more advanced machines we’ll most likely have to seek out new algorithms and data structures.</p><p>But that, my friend, is a story for another post.</p><blockquote><p>Blogging teaches the attitude of the knife — chopping off what’s incomplete and saying: “Now it’s complete because it’s ended here.”</p><p>– <em>Frank Herbert (ish)</em></p></blockquote></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/interpreter/" class="post-tag no-text-decoration" >Interpreter</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Trying out different interpreter implementations - /* Insert Code Here */&url=https://faouellet.github.io//interpreter/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Trying out different interpreter implementations - /* Insert Code Here */&u=https://faouellet.github.io//interpreter/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Trying out different interpreter implementations - /* Insert Code Here */&url=https://faouellet.github.io//interpreter/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/database/">Database</a> <a class="post-tag" href="/tags/source-control/">Source Control</a> <a class="post-tag" href="/tags/c/">C++</a> <a class="post-tag" href="/tags/build-system/">Build System</a> <a class="post-tag" href="/tags/parallelism/">Parallelism</a> <a class="post-tag" href="/tags/compiler-development/">Compiler Development</a> <a class="post-tag" href="/tags/software-development/">Software Development</a> <a class="post-tag" href="/tags/c-amp/">C++AMP</a> <a class="post-tag" href="/tags/concurrency/">Concurrency</a> <a class="post-tag" href="/tags/gpgpu/">GPGPU</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/dvcs-next/"><div class="card-body"> <span class="timeago small" > Feb 9 <i class="unloaded">2021-02-09T00:00:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Of source control and databases - Annex C - Further developments</h3><div class="text-muted small"><p> All the code for the articles in this series can be found here. For those of you interested in deepening your understanding of distributed source control systems, here are some projects to ext...</p></div></div></a></div><div class="card"> <a href="/dvcs-error/"><div class="card-body"> <span class="timeago small" > Feb 8 <i class="unloaded">2021-02-08T00:00:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Of source control and databases - Annex B - Error management</h3><div class="text-muted small"><p> All the code for the articles in this series can be found here. To cap off this series, I wanted to talk about how I approached error management in DVCSUS. I already went into details for some...</p></div></div></a></div><div class="card"> <a href="/dvcs-tests/"><div class="card-body"> <span class="timeago small" > Feb 7 <i class="unloaded">2021-02-07T00:00:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Of source control and databases - Annex A - Testing strategies</h3><div class="text-muted small"><p> All the code for the articles in this series can be found here. While programming something new is always fun, there comes a time when we have to put our invention to the test. Can the thing w...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/bst-par/" class="btn btn-outline-primary"><p>Building a build system - Part 3 - Parallel Compilation</p></a> <a href="/refactoring/" class="btn btn-outline-primary"><p>Refactoring 101</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="font-italic text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> var options = { scriptUrl: '//insertcodehere.disqus.com/embed.js', disqusConfig: function() { this.page.url = 'https://faouellet.github.io//interpreter/'; this.page.identifier = '/interpreter/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://github.com/faouellet">Félix-Antoine Ouellet</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/database/">Database</a> <a class="post-tag" href="/tags/source-control/">Source Control</a> <a class="post-tag" href="/tags/c/">C++</a> <a class="post-tag" href="/tags/build-system/">Build System</a> <a class="post-tag" href="/tags/parallelism/">Parallelism</a> <a class="post-tag" href="/tags/compiler-development/">Compiler Development</a> <a class="post-tag" href="/tags/software-development/">Software Development</a> <a class="post-tag" href="/tags/c-amp/">C++AMP</a> <a class="post-tag" href="/tags/concurrency/">Concurrency</a> <a class="post-tag" href="/tags/gpgpu/">GPGPU</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://faouellet.github.io/{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
