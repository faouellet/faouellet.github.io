<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.1"><meta name="generator" content="Jekyll v4.1.1" /><meta property="og:title" content="Building a build system - Part 3 - Parallel Compilation" /><meta name="author" content="Félix-Antoine Ouellet" /><meta property="og:locale" content="en_US" /><meta name="description" content="In which we ponder how to accelerate a build system" /><meta property="og:description" content="In which we ponder how to accelerate a build system" /><link rel="canonical" href="https://faouellet.github.io//bst-par/" /><meta property="og:url" content="https://faouellet.github.io//bst-par/" /><meta property="og:site_name" content="/* Insert Code Here */" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2018-04-28T00:00:00-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Building a build system - Part 3 - Parallel Compilation" /> <script type="application/ld+json"> {"description":"In which we ponder how to accelerate a build system","url":"https://faouellet.github.io//bst-par/","headline":"Building a build system - Part 3 - Parallel Compilation","dateModified":"2018-04-28T00:00:00-04:00","@type":"BlogPosting","datePublished":"2018-04-28T00:00:00-04:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://faouellet.github.io//bst-par/"},"author":{"@type":"Person","name":"Félix-Antoine Ouellet"},"@context":"https://schema.org"}</script><title>Building a build system - Part 3 - Parallel Compilation | /* Insert Code Here */</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-71911238-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-71911238-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">/* Insert Code Here */</a></div><div class="site-subtitle font-italic"></div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/faouellet" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://www.linkedin.com/in/felixantoineouellet/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['faouellet','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Building a build system - Part 3 - Parallel Compilation</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Building a build system - Part 3 - Parallel Compilation</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Apr 28, 2018, 12:00 AM -0400" > Apr 28, 2018 <i class="unloaded">2018-04-28T00:00:00-04:00</i> </span> by <span class="author"> Félix-Antoine Ouellet </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1203 words">6 min</span></div></div><div class="post-content"><p>At this point in the series, our build system does everything we wanted it to. Throw a simple source code repository at it and it’ll bring you back an application. Why don’t we call it quits now and move on to better things?</p><p>You’re right, we could. But imagine for a second that you’re in the middle of an interview for a post at BigTechCo ®. Suddenly, the interviewer ask you how to scale the build system to billions of files. What do you say? Even worse, you actually managed to pass that interview and now you have to come up with a real solution to the problem. What do you do (besides changing your name and moving to Antarctica)?</p><p>Since I care about you and your mental well-being, I’m going to show you a way to attack (and hopefully go medieval on) the problem at hand.</p><h2 id="going-parallel">Going Parallel</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/depgraph.png" alt="Desktop View" /></p><p>Look at this graph closely. The solution to scale it to infinity and beyond is there. Do you see it?</p><p>There is a *<em>censored</em>* load of parallelism in there!</p><p>Think about it, all of the outputs that are going to come out of this graph will be generated by one of three functions:</p><ol><li>A function that takes a C++ implementation file and returns an object file<li>A function that takes multiple object files and link them into a library file<li>A function that takes multiple library files and an application entry point (a main.cpp if you will) and produce an executable.</ol><p>For the first two functions, the build system will have to invoke them multiple times using multiple data. If you paid any attention to your parallelism classes in university, you should have a vague feeling of <em>déjà vu</em> and the letters <a href="https://en.wikipedia.org/wiki/SPMD">SPMD</a> should be floating in the Alpha-Bits soup of your mind. If you didn’t then you need to hand back your diploma and apologize to your teachers.</p><h2 id="design-decisions">Design Decisions</h2><p>It would be easy to say that to scale up we just need to start a thread every time we have some task to do. However, you can’t just start threads like you’d buy candies at the convenience store. Your CPUs (and your pancreas) won’t operate optimally when you throw too much work at them. An oversubscribed core is not a happy core. To mitigate this potential problem, here are two possible solutions:</p><h3 id="solution-1">Solution 1</h3><p>Start threads, but only at the highest level. In our case, this would mean that we would assign a thread per subgraph.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="kt">bool</span> <span class="nf">Compile</span><span class="p">(</span><span class="k">const</span> <span class="n">DependencyGraph</span><span class="o">&amp;</span> <span class="n">graph</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">appName</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">const</span> <span class="n">DGN</span><span class="o">&amp;</span> <span class="n">root</span> <span class="o">=</span> <span class="n">graph</span><span class="p">.</span><span class="n">GetRoot</span><span class="p">();</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">libFiles</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;</span> <span class="n">workers</span><span class="p">;</span>

  <span class="c1">// Generating a lib file per subgraph linked to the root node</span>
  <span class="k">for</span><span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">child</span> <span class="o">:</span> <span class="n">root</span><span class="p">.</span><span class="n">GetChildren</span><span class="p">())</span>
  <span class="p">{</span>
      <span class="n">workers</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">([</span><span class="n">child</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">libFiles</span><span class="p">](){</span>
        <span class="cm">/* Process subgraph */</span>
        <span class="cm">/* Be careful to use a mutex to access libFiles */</span>
      <span class="p">});</span>
  <span class="p">}</span>

  <span class="c1">// Every thread needs to be joined before going further</span>
  <span class="k">for</span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="n">w</span> <span class="o">:</span> <span class="n">workers</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">w</span><span class="p">.</span><span class="n">joinable</span><span class="p">())</span>
      <span class="p">{</span>
          <span class="n">w</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
      <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">LinkToExecutable</span><span class="p">(</span><span class="n">libFiles</span><span class="p">,</span> <span class="n">root</span><span class="p">.</span><span class="n">GetFile</span><span class="p">(),</span> <span class="n">appName</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Depending on your machine and the dependency graph at hand, this might still have an oversubscription problem. This leads us to the second solution: using a task-based approach.</p><h3 id="solution-2">Solution 2</h3><p>Don’t directly start threads. Instead, create tasks that a system will process in a parallel fashion. More often than not, this so-called system will be some sort of thread pool that’ll know best how to make the most of the available threads, leaving you with only having to worry about the jobs you want it to process.</p><p>As an example, I’ll be using <strong><code class="language-plaintext highlighter-rouge">std::future</code></strong> which is what the C++ standard library offers in terms of task-based parallelism as of C++17 (well not quite really, but this is the best we have while waiting for executors).</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="kt">bool</span> <span class="nf">Compile</span><span class="p">(</span><span class="k">const</span> <span class="n">DependencyGraph</span><span class="o">&amp;</span> <span class="n">graph</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">appName</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">const</span> <span class="n">DGN</span><span class="o">&amp;</span> <span class="n">root</span> <span class="o">=</span> <span class="n">graph</span><span class="p">.</span><span class="n">GetRoot</span><span class="p">();</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">libFiles</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">future</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;&gt;</span> <span class="n">workers</span><span class="p">;</span>

  <span class="c1">// Generating a lib file per subgraph linked to the root node</span>
  <span class="k">for</span><span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">child</span> <span class="o">:</span> <span class="n">root</span><span class="p">.</span><span class="n">GetChildren</span><span class="p">())</span>
  <span class="p">{</span>
      <span class="n">workers</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span>
          <span class="n">std</span><span class="o">::</span><span class="n">async</span><span class="p">(</span>
              <span class="n">std</span><span class="o">::</span><span class="n">launch</span><span class="o">::</span><span class="n">async</span><span class="p">,</span>
              <span class="p">[</span><span class="o">&amp;</span><span class="n">child</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">libFiles</span><span class="p">](){</span>
              <span class="cm">/* Process subgraph */</span>
              <span class="cm">/* Be careful to use a mutex to access libFiles */</span>
      <span class="p">});</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">when_all</span><span class="p">(</span><span class="n">workers</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">workers</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
                       <span class="p">[</span><span class="o">&amp;</span><span class="n">libFiles</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">appName</span><span class="p">](</span><span class="k">auto</span><span class="p">)</span>
                       <span class="p">{</span>
                           <span class="k">return</span> <span class="n">LinkToExecutable</span><span class="p">(</span><span class="n">libFiles</span><span class="p">,</span>
                                                   <span class="n">root</span><span class="p">.</span><span class="n">GetFile</span><span class="p">(),</span>
                                                   <span class="n">appName</span><span class="p">);</span>
                       <span class="p">}).</span><span class="n">get</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>What’s really beautiful about this approach is that performance won’t really suffer even if we prefer our tasks to be finer grained. Hence, if you wanted to parallelize the compilation of C++ files to object files and the assembly of a library file, you could implement something similar to this.</p><h3 id="beware-theres-recursion-involved">Beware there’s recursion involved!!</h3><p>First, some let’s create some object to hold our compilation logic.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>  <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="k">const</span> <span class="n">Node</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">childNodeFtor</span><span class="p">;</span>
</pre></table></code></div></div><p>We’ll also need something to contain the generated library files.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">libFiles</span><span class="p">;</span>
</pre></table></code></div></div><p>Since we’ll manipulate a collection concurrently, we’ll use a mutex.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>  <span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">objMutex</span><span class="p">;</span>
</pre></table></code></div></div><p>What we want to do now is visit each child of a given node and create a task for each of them. “What will that task entail?” you ask. Visit each child of that node and create a task for each of them. “What will that task entail?”… Alright, I’ll stop here.</p><p>More seriously though, we need to do two things for each node.</p><p>First, visit its children and process them. Doing so require using recursion. This is why we’ll employ a recursive lambda. Also worth mentioning, this lambda will return a <strong><code class="language-plaintext highlighter-rouge">std::vector&lt;std::future&lt;void&gt;&gt;</code></strong>. That way the caller will have something to manipulate if he wants to add a continuation to the processing of the child node.</p><p>Second, create an object file out of the C++ file encapsulated by that node once all its children have been dealt with. Again, using <strong><code class="language-plaintext highlighter-rouge">std::when_all</code></strong> is the way to go. This is where the fact that we return a <strong><code class="language-plaintext highlighter-rouge">std::vector&lt;std::future&lt;void&gt;&gt;</code></strong> will come in handy.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre>  <span class="n">childNodeFtor</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">objMutex</span><span class="p">](</span><span class="k">const</span> <span class="n">Node</span><span class="o">&amp;</span> <span class="n">node</span><span class="p">,</span>
                              <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">objFiles</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">future</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;&gt;</span> <span class="n">childWorkers</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">child</span> <span class="o">:</span> <span class="n">node</span><span class="p">.</span><span class="n">GetChildren</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">childWorkers</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span>
          <span class="n">std</span><span class="o">::</span><span class="n">async</span><span class="p">(</span>
              <span class="n">std</span><span class="o">::</span><span class="n">launch</span><span class="o">::</span><span class="n">async</span><span class="p">,</span>
              <span class="p">[</span><span class="o">&amp;</span><span class="n">child</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">objMutex</span><span class="p">](</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">objFiles</span><span class="p">)</span>
              <span class="p">{</span>
                <span class="c1">// We need to process the node's children now</span>
                <span class="c1">// because they'll be needed to compile the node</span>
                <span class="k">auto</span> <span class="n">grandchildWorkers</span><span class="p">{</span> <span class="n">childNodeFtor</span><span class="p">(</span><span class="n">child</span><span class="p">)</span> <span class="p">};</span>

                <span class="c1">// Wait for the children then</span>
                <span class="n">std</span><span class="o">::</span><span class="n">when_all</span><span class="p">(</span>
                    <span class="n">grandchildWorkers</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span>
                    <span class="n">grandchildWorkers</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
                    <span class="p">[</span><span class="o">&amp;</span><span class="n">objMutex</span><span class="p">]()</span>
                    <span class="p">{</span>
                      <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">objLock</span><span class="p">{</span><span class="n">objMutex</span><span class="p">};</span>
                      <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">wstring</span><span class="o">&amp;</span> <span class="n">cppFile</span> <span class="o">=</span> <span class="n">child</span><span class="p">.</span><span class="n">GetFile</span><span class="p">();</span>
                      <span class="n">objFiles</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">CompileFile</span><span class="p">(</span><span class="n">cppFile</span><span class="p">));</span>
                    <span class="p">};</span>
              <span class="p">}));</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">childWorkers</span><span class="p">;</span>
  <span class="p">}</span>
</pre></table></code></div></div><p>All the ingredients have been prepared, so put it in the oven and let it cook.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>  <span class="k">for</span><span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">child</span> <span class="o">:</span> <span class="n">root</span><span class="p">.</span><span class="n">GetChildren</span><span class="p">())</span>
  <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">objFiles</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">future</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;&gt;</span> <span class="n">childWorkers</span><span class="p">;</span>
    <span class="n">childWorkers</span> <span class="o">=</span> <span class="n">childNodeFtor</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">objFiles</span><span class="p">);</span>

    <span class="n">std</span><span class="o">::</span><span class="n">when_all</span><span class="p">(</span><span class="n">childWorkers</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">childWorkers</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
                  <span class="p">[</span><span class="o">&amp;</span><span class="n">objFiles</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">libFiles</span><span class="p">]()</span>
                  <span class="p">{</span>
                    <span class="n">libFiles</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">LinkToLibrary</span><span class="p">(</span><span class="n">objFiles</span><span class="p">));</span>
                  <span class="p">});</span>
  <span class="p">}</span>
<span class="err">}</span>
</pre></table></code></div></div><p>Note that, at the top level, having a <strong><code class="language-plaintext highlighter-rouge">std::vector&lt;std::future&lt;void&gt;&gt;</code></strong> returned to us is useful to us because it allow us to assemble library files in a timely fashion.</p><p>See, as with the reaper, you don’t have to fear recursion.</p><p><strong>Coming up next</strong>: What’s more efficient than running all our cores at full throttle?</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/building-a-build-system/'>Building a build system</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/build-system/" class="post-tag no-text-decoration" >Build System</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Building a build system - Part 3 - Parallel Compilation - /* Insert Code Here */&url=https://faouellet.github.io//bst-par/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Building a build system - Part 3 - Parallel Compilation - /* Insert Code Here */&u=https://faouellet.github.io//bst-par/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Building a build system - Part 3 - Parallel Compilation - /* Insert Code Here */&url=https://faouellet.github.io//bst-par/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/database/">Database</a> <a class="post-tag" href="/tags/source-control/">Source Control</a> <a class="post-tag" href="/tags/c/">C++</a> <a class="post-tag" href="/tags/build-system/">Build System</a> <a class="post-tag" href="/tags/parallelism/">Parallelism</a> <a class="post-tag" href="/tags/compiler-development/">Compiler Development</a> <a class="post-tag" href="/tags/software-development/">Software Development</a> <a class="post-tag" href="/tags/c-amp/">C++AMP</a> <a class="post-tag" href="/tags/concurrency/">Concurrency</a> <a class="post-tag" href="/tags/gpgpu/">GPGPU</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/bst-intro/"><div class="card-body"> <span class="timeago small" > Jan 31, 2018 <i class="unloaded">2018-01-31T00:00:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Building a build system - Part 0 - Intro</h3><div class="text-muted small"><p> In the fall of 2017, I had the opportunity to help a friend working at the University of Sherbrooke rebuild a course from the ground up. This course, IGL 601, had unfortunately devolved over the ye...</p></div></div></a></div><div class="card"> <a href="/bst-dg/"><div class="card-body"> <span class="timeago small" > Feb 28, 2018 <i class="unloaded">2018-02-28T00:00:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Building a build system - Part 1 - Dependency graph</h3><div class="text-muted small"><p> How hard could it be to produce an executable out of some C++ files? Compiling a C++ application (the wrong way) A knee-jerk response to the question could be: “Not much! I just need to compile e...</p></div></div></a></div><div class="card"> <a href="/bst-comp/"><div class="card-body"> <span class="timeago small" > Mar 31, 2018 <i class="unloaded">2018-03-31T00:00:00-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Building a build system - Part 2 - Compilation</h3><div class="text-muted small"><p> Have you ever sat in a data structures or algorithms class wondering why the teacher spend so much time on graph theory? Isn’t graph theory only useful for cracking the code interview? (I still can...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/bst-comp/" class="btn btn-outline-primary"><p>Building a build system - Part 2 - Compilation</p></a> <a href="/interpreter/" class="btn btn-outline-primary"><p>Trying out different interpreter implementations</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="font-italic text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> var options = { scriptUrl: '//insertcodehere.disqus.com/embed.js', disqusConfig: function() { this.page.url = 'https://faouellet.github.io//bst-par/'; this.page.identifier = '/bst-par/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://github.com/faouellet">Félix-Antoine Ouellet</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/database/">Database</a> <a class="post-tag" href="/tags/source-control/">Source Control</a> <a class="post-tag" href="/tags/c/">C++</a> <a class="post-tag" href="/tags/build-system/">Build System</a> <a class="post-tag" href="/tags/parallelism/">Parallelism</a> <a class="post-tag" href="/tags/compiler-development/">Compiler Development</a> <a class="post-tag" href="/tags/software-development/">Software Development</a> <a class="post-tag" href="/tags/c-amp/">C++AMP</a> <a class="post-tag" href="/tags/concurrency/">Concurrency</a> <a class="post-tag" href="/tags/gpgpu/">GPGPU</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://faouellet.github.io/{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
