<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.1"><meta name="generator" content="Jekyll v4.1.1" /><meta property="og:title" content="A deadlock-detecting mutex" /><meta name="author" content="Félix-Antoine Ouellet" /><meta property="og:locale" content="en_US" /><meta name="description" content="Sounds crazy but can be done in less than 100 LOC" /><meta property="og:description" content="Sounds crazy but can be done in less than 100 LOC" /><link rel="canonical" href="https://faouellet.github.io//ddmutex/" /><meta property="og:url" content="https://faouellet.github.io//ddmutex/" /><meta property="og:site_name" content="/* Insert Code Here */" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2017-05-07T00:00:00-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="A deadlock-detecting mutex" /> <script type="application/ld+json"> {"description":"Sounds crazy but can be done in less than 100 LOC","url":"https://faouellet.github.io//ddmutex/","headline":"A deadlock-detecting mutex","dateModified":"2017-05-07T00:00:00-04:00","@type":"BlogPosting","datePublished":"2017-05-07T00:00:00-04:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://faouellet.github.io//ddmutex/"},"author":{"@type":"Person","name":"Félix-Antoine Ouellet"},"@context":"https://schema.org"}</script><title>A deadlock-detecting mutex | /* Insert Code Here */</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-71911238-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-71911238-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">/* Insert Code Here */</a></div><div class="site-subtitle font-italic"></div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/faouellet" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://www.linkedin.com/in/felixantoineouellet/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['faouellet','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>A deadlock-detecting mutex</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>A deadlock-detecting mutex</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, May 7, 2017, 12:00 AM -0400" > May 7, 2017 <i class="unloaded">2017-05-07T00:00:00-04:00</i> </span> by <span class="author"> Félix-Antoine Ouellet </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1074 words">5 min</span></div></div><div class="post-content"><hr /><p>All the code for this article can be found <a href="https://github.com/faouellet/Sandbox/blob/master/Parallelism/DeadlockDetection.cpp">here</a>.</p><hr /><p>Here’s an idea for you: wouldn’t it be nice if a mutex could warn us that we’re going to deadlock the very moment we’re trying to acquire it? It may sounds far-fetched but it is very doable but it is probably quite simpler than you imagine.</p><h2 id="a-bit-of-background">A bit of background</h2><p>Traditionally, we define a deadlock as the situation in which each member of a group of threads is waiting on a resource held by another member of said group. For those more visually-inclined, here’s what it looks like through the lens of a resource allocation graph.</p><figure><p style="text-align:center;"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/deadlock.png" alt="Image: Don't cross the streams" /></p><figcaption><span><center><i>Don't cross the streams</i></center></span></figcaption></figure><p>While explicit, this graph is a bit too much for what we’re going for in this article. Instead, we’ll use a version of this graph where the resource ownership is implicit. We thus end up with what is commonly referred to as a wait-for graph.</p><figure><p style="text-align:center;"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/waitfor.png" alt="Image: Everyone's waiting" /></p><figcaption><span><center><i>Everyone's waiting</i></center></span></figcaption></figure><p>Once we have this graph, it naturally follows that we only have to find out if it contains at least a cycle to say if we’re going to deadlock or not.</p><h2 id="the-wait-for-graph">The wait-for graph</h2><p>To quickly prototype our idea, we’ll use the <a href="http://www.boost.org/doc/libs/1_64_0/libs/graph/doc/index.html">Boost Graph Library</a> (BGL). Our chosen graph representation will be a labeled graph where each vertex is labeled by a thread ID.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">using</span> <span class="n">ThreadID</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">::</span><span class="n">id</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">WaitForGraph</span>
<span class="p">{</span>
<span class="nl">private:</span>
  <span class="k">using</span> <span class="n">GraphT</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">labeled_graph</span><span class="o">&lt;</span>
                    <span class="n">boost</span><span class="o">::</span><span class="n">adjacency_list</span><span class="o">&lt;</span> <span class="c1">// Graph representation</span>
                      <span class="n">boost</span><span class="o">::</span><span class="n">vecS</span><span class="p">,</span>       <span class="c1">// Edge storage</span>
                      <span class="n">boost</span><span class="o">::</span><span class="n">vecS</span><span class="p">,</span>       <span class="c1">// Vertex storage</span>
                      <span class="n">boost</span><span class="o">::</span><span class="n">directedS</span><span class="o">&gt;</span><span class="p">,</span> <span class="c1">// Directed graph</span>
                    <span class="n">ThreadID</span><span class="o">&gt;</span><span class="p">;</span> <span class="c1">// Vertex label</span>
</pre></table></code></div></div><p>In addition of an internal graph, the <code class="language-plaintext highlighter-rouge">WaitForGraph</code> will also contain a mutex to moderate all the concurrent accesses it’ll be subjected to.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nl">private:</span>
  <span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">mMutex</span><span class="p">;</span>
  <span class="n">GraphT</span> <span class="n">mGraph</span><span class="p">;</span>
</pre></table></code></div></div><p>For the purpose of our demonstration, the <code class="language-plaintext highlighter-rouge">WaitForGraph</code> instance we’ll use will be at the global scope. Such being the case, I went ahead and made it a singleton. This comes with the added bonus that it will be inherently thread-safe since the initialization of local static variables is thread-safe as per the C++ standard since C++11.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="nl">public:</span>
  <span class="k">static</span> <span class="n">WaitForGraph</span><span class="o">&amp;</span> <span class="n">get</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">static</span> <span class="n">WaitForGraph</span> <span class="n">graph</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">graph</span><span class="p">;</span>
  <span class="p">}</span>

<span class="k">public</span><span class="o">:</span>
  <span class="n">WaitForGraph</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
  <span class="n">WaitForGraph</span><span class="p">(</span><span class="k">const</span> <span class="n">WaitForGraph</span><span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
  <span class="n">WaitForGraph</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">WaitForGraph</span><span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
  <span class="n">WaitForGraph</span><span class="p">(</span><span class="n">WaitForGraph</span><span class="o">&amp;&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
  <span class="n">WaitForGraph</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">WaitForGraph</span><span class="o">&amp;&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
</pre></table></code></div></div><p>We’ll defer the insertion and deletion of a vertex to BGL.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="nl">public:</span>
  <span class="kt">void</span> <span class="nf">AddNode</span><span class="p">(</span><span class="k">const</span> <span class="n">ThreadID</span><span class="o">&amp;</span> <span class="n">tid</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lg</span><span class="p">{</span><span class="n">mMutex</span><span class="p">};</span>
    <span class="n">boost</span><span class="o">::</span><span class="n">add_vertex</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">mGraph</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="nf">RemoveNode</span><span class="p">(</span><span class="k">const</span> <span class="n">ThreadID</span><span class="o">&amp;</span> <span class="n">tid</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lg</span><span class="p">{</span><span class="n">mMutex</span><span class="p">};</span>
    <span class="n">boost</span><span class="o">::</span><span class="n">clear_vertex_by_label</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">mGraph</span><span class="p">);</span>
  <span class="p">}</span>
</pre></table></code></div></div><p>Now for the fun part. When adding and edge between to vertices, we’ll want to make sure that doing so won’t introduce a cycle in the graph (i.e. we’re not creating a deadlock). Luckily for us, BGL offers a function that can detect the strongly connected components (SCCs) in a graph. For those lacking in graph theory, a SCC is a subgraph in which every vertex is reachable from every other vertex.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/scc.png" alt="Desktop View" /></p><p>In the example above, we have two SCC. One is composed of the vertices 0,1 and 2 and the other one is made up of the vertices 4,5,6 and 7.</p><p>It’s quite plain to see that a SCC in a directed graph like ours means that there is a cycle in the graph.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="nl">public:</span>
  <span class="kt">void</span> <span class="nf">AddEdge</span><span class="p">(</span><span class="k">const</span> <span class="n">ThreadID</span><span class="o">&amp;</span> <span class="n">fromTID</span><span class="p">,</span> <span class="k">const</span> <span class="n">ThreadID</span><span class="o">&amp;</span> <span class="n">toTID</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="p">{</span><span class="n">mMutex</span><span class="p">};</span>

    <span class="n">boost</span><span class="o">::</span><span class="n">add_edge_by_label</span><span class="p">(</span><span class="n">fromTID</span><span class="p">,</span> <span class="n">toTID</span><span class="p">,</span> <span class="n">mGraph</span><span class="p">);</span>

    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">sccs</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">num_vertices</span><span class="p">(</span><span class="n">mGraph</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">connected_components</span><span class="p">(</span><span class="n">mGraph</span><span class="p">,</span> <span class="n">sccs</span><span class="p">.</span><span class="n">data</span><span class="p">())</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"DEADLOCK DETECTED:</span><span class="se">\n</span><span class="s">"</span>
                <span class="o">&lt;&lt;</span> <span class="s">"Thread 1 ID: "</span> <span class="o">&lt;&lt;</span> <span class="n">fromTID</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span>
                <span class="o">&lt;&lt;</span> <span class="s">"Thread 2 ID: "</span> <span class="o">&lt;&lt;</span> <span class="n">toTID</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
</pre></table></code></div></div><p>While we could certainly be more clever in our management of deadlocks, our goal here is simply to warn the user that a deadlock is occuring in the application. Consequently, the message proposed here will do the job.</p><h2 id="the-ddmutex">The DDMutex</h2><p>To build a deadlock-detecting mutex we’ll need three things. First, a real mutex to make it work (duh!). Second, we need a way to identify the current owner of the mutex such as an ID. And, finally, third, we need a structure that will tell us if the mutex is presently owned.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">DDMutex</span>
<span class="p">{</span>
<span class="nl">private:</span>
  <span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">mMutex</span><span class="p">;</span>
  <span class="n">ThreadID</span> <span class="n">mOwnerID</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">mIsOwned</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</pre></table></code></div></div><p>Going into the <code class="language-plaintext highlighter-rouge">Lock</code> method, we’ll want to make sure that there is a vertex for the current thread in the <code class="language-plaintext highlighter-rouge">WaitForGraph</code>. This will be done by unconditionally adding a vertex to the <code class="language-plaintext highlighter-rouge">WaitForGraph</code>. Worry not, this won’t create duplicate vertices since a <code class="language-plaintext highlighter-rouge">boost::labeled_graph</code> guarantees that no two vertices shall have the same label.</p><p>After this is done, if the mutex is currently owned by some other thread, we’ll add an edge between the vertices representing the owner thread and the current thread. This will fire the deadlock detection algorithm of the <code class="language-plaintext highlighter-rouge">WaitForGraph</code>. If worst comes to worst, then we’ll be shout at that we’re creating a deadlock.</p><p>Afterwards, we can lock the <code class="language-plaintext highlighter-rouge">DDMutex</code> and update its internal state to make it clear it’s owned by the current thread.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="nl">public:</span>
  <span class="kt">void</span> <span class="nf">Lock</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">ThreadID</span> <span class="n">currTID</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">get_id</span><span class="p">();</span>
    <span class="n">WaitForGraph</span><span class="o">::</span><span class="n">get</span><span class="p">().</span><span class="n">AddNode</span><span class="p">(</span><span class="n">currTID</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">mIsOwned</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">WaitForGraph</span><span class="o">::</span><span class="n">get</span><span class="p">().</span><span class="n">AddEdge</span><span class="p">(</span><span class="n">mOwnerID</span><span class="p">,</span> <span class="n">currTID</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">mMutex</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
    <span class="n">mOwnerID</span> <span class="o">=</span> <span class="n">currTID</span><span class="p">;</span>
    <span class="n">mIsOwned</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
</pre></table></code></div></div><p>Finally, the <code class="language-plaintext highlighter-rouge">Unlock</code> method will undo what the <code class="language-plaintext highlighter-rouge">Lock</code> has done.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nl">public:</span>
  <span class="kt">void</span> <span class="nf">Unlock</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">WaitForGraph</span><span class="o">::</span><span class="n">get</span><span class="p">().</span><span class="n">RemoveNode</span><span class="p">(</span><span class="n">mOwnerID</span><span class="p">);</span>
    <span class="n">mIsOwned</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">mMutex</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
  <span class="p">}</span>
</pre></table></code></div></div><p>One thing to note is that I’ve chosen to bluntly remove the vertex representing the owner from the <code class="language-plaintext highlighter-rouge">WaitForGraph</code>. I know could’ve been way smarter about my management of the <code class="language-plaintext highlighter-rouge">WaitForGraph</code> but let’s say I decided to left it as an exercise to the reader.</p><h2 id="putting-it-to-the-test">Putting it to the test</h2><p>if we run the following program:</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono_literals</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">DDMutex</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">;</span>

  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;</span> <span class="n">threads</span><span class="p">;</span>

  <span class="n">threads</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">([</span><span class="o">&amp;</span><span class="n">m1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m2</span><span class="p">]()</span>
                       <span class="p">{</span>
                         <span class="n">m1</span><span class="p">.</span><span class="n">Lock</span><span class="p">();</span>
                         <span class="n">m2</span><span class="p">.</span><span class="n">Lock</span><span class="p">();</span>
                         <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="mx">1s</span><span class="p">);</span>
                         <span class="n">m1</span><span class="p">.</span><span class="n">Unlock</span><span class="p">();</span>
                         <span class="n">m2</span><span class="p">.</span><span class="n">Unlock</span><span class="p">();</span>
                       <span class="p">});</span>
  
  <span class="n">threads</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">([</span><span class="o">&amp;</span><span class="n">m1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m2</span><span class="p">]()</span>
                       <span class="p">{</span>
                         <span class="n">m2</span><span class="p">.</span><span class="n">Lock</span><span class="p">();</span>
                         <span class="n">m1</span><span class="p">.</span><span class="n">Lock</span><span class="p">();</span>
                         <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="mx">1s</span><span class="p">);</span>
                         <span class="n">m2</span><span class="p">.</span><span class="n">Unlock</span><span class="p">();</span>
                         <span class="n">m1</span><span class="p">.</span><span class="n">Unlock</span><span class="p">();</span>
                       <span class="p">});</span>

  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="n">th</span> <span class="o">:</span> <span class="n">threads</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">th</span><span class="p">.</span><span class="n">joinable</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">th</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>This is what we can end up with:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/detection.png" alt="Desktop View" /></p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/c/" class="post-tag no-text-decoration" >C++</a> <a href="/tags/concurrency/" class="post-tag no-text-decoration" >Concurrency</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=A deadlock-detecting mutex - /* Insert Code Here */&url=https://faouellet.github.io//ddmutex/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=A deadlock-detecting mutex - /* Insert Code Here */&u=https://faouellet.github.io//ddmutex/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=A deadlock-detecting mutex - /* Insert Code Here */&url=https://faouellet.github.io//ddmutex/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/database/">Database</a> <a class="post-tag" href="/tags/source-control/">Source Control</a> <a class="post-tag" href="/tags/c/">C++</a> <a class="post-tag" href="/tags/build-system/">Build System</a> <a class="post-tag" href="/tags/parallelism/">Parallelism</a> <a class="post-tag" href="/tags/compiler-development/">Compiler Development</a> <a class="post-tag" href="/tags/software-development/">Software Development</a> <a class="post-tag" href="/tags/c-amp/">C++AMP</a> <a class="post-tag" href="/tags/concurrency/">Concurrency</a> <a class="post-tag" href="/tags/gpgpu/">GPGPU</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/unrestricted-unions/"><div class="card-body"> <span class="timeago small" > Aug 19, 2016 <i class="unloaded">2016-08-19T00:00:00-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>The joys and pains of unrestricted unions</h3><div class="text-muted small"><p> One of the less talked about features of C++11 are unrestricted unions. In this post, I’ll explain what they are, how they’ve been useful to me and why we’ll quickly forget about them in the future...</p></div></div></a></div><div class="card"> <a href="/enumerate/"><div class="card-body"> <span class="timeago small" > Sep 11, 2016 <i class="unloaded">2016-09-11T00:00:00-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Python-like enumeration in C++</h3><div class="text-muted small"><p> Story time During a recent conversation with one of the architects at the company I work for, an interesting topic came up. While talking, about range-based for loops, he mentionned that there was...</p></div></div></a></div><div class="card"> <a href="/race-detection/"><div class="card-body"> <span class="timeago small" > Oct 10, 2016 <i class="unloaded">2016-10-10T00:00:00-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Homemade data race detector</h3><div class="text-muted small"><p> Note 1: What I’m presenting here is evidently not a production grade tool. In fact, I’d say it barely even qualify as a proof of concept. If you really want to debug multithreaded programs, please ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/ampr/" class="btn btn-outline-primary"><p>AMPR</p></a> <a href="/bst-intro/" class="btn btn-outline-primary"><p>Building a build system - Part 0 - Intro</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="font-italic text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> var options = { scriptUrl: '//insertcodehere.disqus.com/embed.js', disqusConfig: function() { this.page.url = 'https://faouellet.github.io//ddmutex/'; this.page.identifier = '/ddmutex/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://github.com/faouellet">Félix-Antoine Ouellet</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/database/">Database</a> <a class="post-tag" href="/tags/source-control/">Source Control</a> <a class="post-tag" href="/tags/c/">C++</a> <a class="post-tag" href="/tags/build-system/">Build System</a> <a class="post-tag" href="/tags/parallelism/">Parallelism</a> <a class="post-tag" href="/tags/compiler-development/">Compiler Development</a> <a class="post-tag" href="/tags/software-development/">Software Development</a> <a class="post-tag" href="/tags/c-amp/">C++AMP</a> <a class="post-tag" href="/tags/concurrency/">Concurrency</a> <a class="post-tag" href="/tags/gpgpu/">GPGPU</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://faouellet.github.io/{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
